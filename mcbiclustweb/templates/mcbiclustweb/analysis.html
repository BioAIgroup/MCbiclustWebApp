{% extends 'mcbiclustweb/base.html' %}

{% block content %}

{% include "mcbiclustweb/navbar.html"%}

<div class="container pt-5">
    <h1>{{ analysis.name }}</h1>
    <hr class="mb-4" style="border-top: 2px solid rgba(0, 0, 0, 0.1);">
    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <label><b>Description</b></label>
            </div>
            <div class="col-md-9">
                <p>{{ analysis.description }}</p>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <label><b>Status</b></label>
            </div>
            <div class="col-md-9">
                <p>{{ analysis.status|capfirst }}</p>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <label><b>Date Started</b></label>
            </div>
            <div class="col-md-9">
                <p>{{ analysis.date_started }}</p>
            </div>
        </div>
        <hr class="mb-2">
        {% if analysis.status == "pending" or 'failed' in analysis.status %}
        <div>
            <form id="startAnalysisForm" action="{% url 'mcbiclustweb:start' analysis.id %}" method="POST" enctype="multipart/form-data" novalidate="">
                {% csrf_token %}
                <div class="form-group">
                    <label for="seedSize">
                        Sample Seed Size
                        <small class="form-text text-muted">
                            Choose the sample size of your seed.
                        </small>
                    </label>
                    <input id="seedSize" class="form-control" name="seedSize" required="" min="1" type="number">
                    <div class="invalid-feedback">
                        Please provide an integer input.
                    </div>
                </div>
                <div class="form-group">
                    <label for="initSeed">
                        Initial Sample Seed
                        <small class="form-text text-muted">
                            Enter the initial sample seed separate by commas only. Note that if the number of initial sample seeds specified is not equal to Sample Seed Size, the algorithm will choose a random inital seed instead. (Optional)
                        </small>
                    </label>
                    <textarea id="initSeed" class="form-control" name="initSeed" row="3" type="text"></textarea>
                    <div id="incorrectFormat" class="invalid-feedback">
                        Please verify that the number of initial seeds entered is equal to the seed size specified above.
                    </div>
                </div>
                <div class="form-group">
                    <label for="geneset">
                        Geneset of Interest
                        <small class="form-text text-muted">
                            Please upload a text file with the genes separate by commas only. Please use the gene names from the gene expression matrix. Use no more than 500 genes.
                        </small>
                    </label>
                    <input id="geneset" class="form-control" name="geneset" required="" type="file">
                    <div id="incorrectExt" class="invalid-feedback">
                        Please.
                    </div>
                </div>
                <div class="form-group">
                    <label for="iterations">
                        Iterations
                        <small class="form-text text-muted">
                            Choose the number of iterations to run each FindSeed algorithm.
                        </small>
                    </label>
                    <input id="iterations" class="form-control" name="iterations" min="1" required="" type="number">
                    <div class="invalid-feedback">
                        Please provide an integer input.
                    </div>
                </div>
                <div class="form-group">
                    <label for="numRuns">
                        Number of runs
                        <small class="form-text text-muted">
                            Choose the number of runs of the FindSeed algorithm.
                        </small>
                    </label>
                    <input id="numRuns" class="form-control" name="numRuns" required="" min="1" type="number">
                    <div class="invalid-feedback">
                        Please provide an integer input.
                    </div>
                </div>
                <input class="btn btn-primary btn-lg" type="submit" name="submit" value="Start Analysis">
            </form>
        </div>
        {% endif %}
    </div>
</div>

<script>
    $('document').ready(function() {
        function getExtension(fileName) {
            var parts = fileName.split('.');
            return parts[parts.length - 1];
        }

        var monitorUpload = false;
        function validateUpload(event=null) {
            monitorUpload = true;
            var fileName = $('#geneset').val()
            if (getExtension(fileName) !== 'txt') {
                $('#incorrectExt').css('display', 'block');
                $('#geneset').css('border-color', '#dc3545');
                if (event !== null) {
                    event.preventDefault();
                    event.stopPropagation();
                }
            } else {
                $('#incorrectExt').css('display', 'none');
                $('#geneset').css('border-color', '#28a745');
            }
        }
        var monitorInitSeed = false;
        function validateInitSeed(event=null) {
            monitorInitSeed = true;
            var initSeeds = $('#initSeed').val().split(',');
            if (initSeeds[initSeeds.length - 1] == "")
                initSeeds.pop();
            var seedSize = $('#seedSize').val();
            if (seedSize != initSeeds.length) {
                $('#incorrectFormat').css('display', 'block');
                $('#initSeed').css('border-color', '#dc3545');
                if (event !== null) {
                    event.preventDefault();
                    event.stopPropagation();
                }
            } else {
                $('#incorrectFormat').css('display', 'none');
                $('#initSeed').css('border-color', '#28a745');
            }
        }

        var startAnalysisForm = document.getElementById('startAnalysisForm');
        $('#startAnalysisForm').submit(function( event ) {
            if (startAnalysisForm.checkValidity() === false) {
                event.preventDefault();
                event.stopPropagation();
            }
            validateUpload(event);
            if ($('#initSeed').val() != "")
                validateInitSeed(event);

            $('#startAnalysisForm').addClass("was-validated");
        });

        $('#initSeed').keyup(function() {
            console.log('change')
            if ($('#initSeed').val() != "")
                validateInitSeed(event);
        });
        $('#geneset').change(function() {
            if (monitorUpload)
                validateUpload();
        });
    });
</script>

{% endblock %}